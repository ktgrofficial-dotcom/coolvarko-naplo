<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#7ec800"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Coolvarko"/>
  <meta name="description" content="Coolvarko Kft. â€” Ã‰pÃ­tÃ©si NaplÃ³"/>
  <title>Coolvarko NaplÃ³</title>
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="icon-192.png"/>
  <link rel="icon" href="icon-192.png"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet"/>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, query, orderBy, onSnapshot, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyDBUNmqnDZszO7tMS8kR8Y5UWAfFnXalzM",
      authDomain: "coolvarko-kft.firebaseapp.com",
      projectId: "coolvarko-kft",
      storageBucket: "coolvarko-kft.firebasestorage.app",
      messagingSenderId: "334119129410",
      appId: "1:334119129410:web:430a7b2ec7f0f72ec4f8db"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.FB = {
      naploFigyel: (cb) => { const q = query(collection(db,"naplo"), orderBy("datum","desc")); return onSnapshot(q, snap => cb(snap.docs.map(d=>({id:d.id,...d.data()})))); },
      naploMent: (adat) => addDoc(collection(db,"naplo"), {...adat, rogzitve: new Date().toISOString()}),
      naploTorol: (id) => deleteDoc(doc(db,"naplo",id)),
      naploFrissit: (id, adat) => updateDoc(doc(db,"naplo",id), {...adat, modositva: new Date().toISOString()}),
      projektekFigyel: (cb) => onSnapshot(collection(db,"projektek"), snap => cb(snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(a.nev||"").localeCompare(b.nev||"")))),
      projektMent: (adat) => addDoc(collection(db,"projektek"), {...adat, letrehozva: new Date().toISOString()}),
      projektTorol: (id) => deleteDoc(doc(db,"projektek",id)),
      beallitasokLeker: async () => { const d = await getDoc(doc(db,"beallitasok","admin")); return d.exists() ? d.data() : {pin:"1234"}; },
      beallitasokMent: (adat) => setDoc(doc(db,"beallitasok","admin"), adat),
    };
    document.dispatchEvent(new Event("firebase-ready"));
  </script>

  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{--bg:#0d1014;--s1:#161a22;--s2:#1e2430;--brd:#2a3244;--acc:#7ec800;--acd:#5a9200;--a2:#3b82f6;--red:#ef4444;--grn:#22c55e;--amber:#f59e0b;--txt:#e8eaf0;--t2:#8b93a8;--t3:#4a5268;--r:10px;}
    html,body{height:100%;overflow:hidden}
    body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--txt);display:flex;justify-content:center}
    #app{width:100%;max-width:480px;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    .hdr{background:var(--s1);border-bottom:3px solid var(--acc);padding:8px 14px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;gap:10px}
    .hdr-r{display:flex;align-items:center;gap:6px;flex-shrink:0}
    .hdr-date{font-size:11px;color:var(--t2);background:var(--s2);padding:4px 8px;border-radius:6px;white-space:nowrap}
    .dot{width:7px;height:7px;border-radius:50%;background:var(--grn);flex-shrink:0}.dot.off{background:var(--red)}
    .nav{display:flex;background:var(--s1);border-top:1px solid var(--brd);flex-shrink:0;padding-bottom:env(safe-area-inset-bottom)}
    .nb{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:9px 2px 8px;border:none;background:none;color:var(--t3);cursor:pointer;font-size:9px;font-family:'Barlow',sans-serif;font-weight:700;text-transform:uppercase;letter-spacing:.5px;border-top:2px solid transparent;-webkit-tap-highlight-color:transparent}
    .nb.on{color:var(--acc);border-top-color:var(--acc)}.nb.adm.on{color:var(--amber);border-top-color:var(--amber)}
    .cnt{flex:1;overflow-y:auto;padding:14px;-webkit-overflow-scrolling:touch}
    .card{background:var(--s1);border:1px solid var(--brd);border-radius:var(--r);padding:15px;margin-bottom:11px}
    .ctit{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:16px;letter-spacing:.5px;text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:7px}
    .fld{margin-bottom:11px}
    .lbl{display:block;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t2);margin-bottom:5px}
    .inp,.sel,.ta{width:100%;background:var(--s2);border:1px solid var(--brd);border-radius:8px;color:var(--txt);font-family:'Barlow',sans-serif;font-size:15px;padding:10px 12px;transition:border-color .15s;appearance:none;-webkit-appearance:none}
    .inp:focus,.sel:focus,.ta:focus{outline:none;border-color:var(--acc)}
    .ta{resize:vertical;min-height:64px}
    .sel{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b93a8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 11px center;padding-right:34px}
    .r2{display:flex;gap:8px}.r2>*{flex:1}
    .btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:11px 16px;border-radius:8px;border:none;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:15px;letter-spacing:.5px;text-transform:uppercase;cursor:pointer;width:100%;-webkit-tap-highlight-color:transparent;transition:opacity .15s}
    .btn:active{opacity:.8}
    .btn-p{background:var(--acc);color:#0d1014}.btn-s{background:var(--s2);color:var(--txt);border:1px solid var(--brd)}.btn-amb{background:var(--amber);color:#0d1014}
    .btn-d{background:transparent;color:var(--red);border:1px solid rgba(239,68,68,.35);padding:5px 9px;width:auto;font-size:11px;border-radius:6px}
    .btn-ic{width:auto;padding:9px 11px}
    .steps{display:flex;gap:4px;margin-bottom:16px}
    .step{flex:1;text-align:center;padding:6px 2px;border-radius:6px;font-size:10px;font-weight:700;text-transform:uppercase;background:var(--s1);color:var(--t3);border:1px solid var(--brd);}
    .step.on{background:var(--acc);color:#0d1014;border-color:var(--acc)}.step.dn{border-color:var(--acd);color:var(--acd)}
    /* AktivitÃ¡s picker */
    .srch-w{position:relative;margin-bottom:9px}
    .srch-ic{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--t3);pointer-events:none}
    .srch-w .inp{padding-left:33px}
    .kath{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.7px;color:var(--acc);margin:9px 0 4px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:4px 6px;border-radius:6px;-webkit-tap-highlight-color:transparent}
    .karr{transition:transform .2s}.karr.op{transform:rotate(180deg)}
    .pg{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:3px}
    .pill{display:inline-flex;align-items:center;background:var(--s2);border:1px solid var(--brd);border-radius:20px;padding:4px 10px;font-size:12px;color:var(--t2);cursor:pointer;white-space:nowrap;-webkit-tap-highlight-color:transparent}
    .pill.on{background:var(--acc);border-color:var(--acc);color:#0d1014;font-weight:700}
    /* MunkÃ¡s kÃ¡rtya */
    .wcard{background:var(--s2);border:1px solid var(--brd);border-radius:var(--r);margin-bottom:10px}
    .wcard-h{display:flex;align-items:center;justify-content:space-between;padding:12px;cursor:pointer;-webkit-tap-highlight-color:transparent}
    .wcard-body{padding:12px;border-top:1px solid var(--brd)}
    /* Log */
    .le{background:var(--s1);border:1px solid var(--brd);border-radius:var(--r);padding:13px;margin-bottom:9px}
    .leh{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:7px}
    .lp{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:14px;color:var(--acc);text-transform:uppercase;letter-spacing:.5px}
    .ld{font-size:12px;color:var(--t2);margin-top:1px}
    .lt{display:inline-block;background:var(--s2);border-radius:4px;padding:2px 6px;font-size:12px;color:var(--t2);margin:2px}
    .lt.w{color:var(--a2)}.lt.m{color:var(--grn)}.lt.r{color:var(--acc)}
    /* Stats */
    .stats{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px}
    .stat{background:var(--s1);border:1px solid var(--brd);border-radius:var(--r);padding:13px}
    .sv{font-family:'Barlow Condensed',sans-serif;font-size:30px;font-weight:800;color:var(--acc);line-height:1}
    .sl{font-size:11px;color:var(--t2);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-top:3px}
    .badge{display:inline-flex;align-items:center;justify-content:center;background:var(--acc);color:#0d1014;border-radius:99px;font-size:10px;font-weight:800;min-width:17px;height:17px;padding:0 4px}
    .stit{font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:19px;text-transform:uppercase;letter-spacing:1px;margin-bottom:14px;border-left:3px solid var(--acc);padding-left:9px}
    .stit.amb{border-left-color:var(--amber)}
    .divd{border:none;border-top:1px solid var(--brd);margin:13px 0}
    .rb{background:rgba(126,200,0,.07);border:1px solid rgba(126,200,0,.22);border-radius:8px;padding:8px 11px;margin-bottom:7px;display:flex;align-items:center;justify-content:space-between}
    .rbn{font-weight:600;font-size:14px}.rba{font-family:'Barlow Condensed',sans-serif;font-weight:700;color:var(--acc);font-size:15px}
    .fb{display:flex;gap:7px;margin-bottom:13px;overflow-x:auto;padding-bottom:3px;scrollbar-width:none}
    .fb::-webkit-scrollbar{display:none}
    .fbb{flex-shrink:0;padding:6px 11px;border-radius:99px;border:1px solid var(--brd);background:var(--s2);color:var(--t2);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;font-family:'Barlow',sans-serif;-webkit-tap-highlight-color:transparent}
    .fbb.on{background:var(--acc);border-color:var(--acc);color:#0d1014}
    .empty{text-align:center;padding:38px 18px;color:var(--t3)}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:300;display:flex;align-items:center;justify-content:center;padding:18px}
    .modal{background:var(--s1);border:1px solid var(--brd);border-radius:14px;padding:22px;width:100%;max-width:360px;max-height:90dvh;overflow-y:auto}
    .modal-tit{font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:19px;text-transform:uppercase;letter-spacing:1px;margin-bottom:14px}
    .adm-card{background:var(--s1);border:1px solid rgba(245,158,11,.28);border-radius:var(--r);padding:14px;margin-bottom:11px}
    .toast{position:fixed;bottom:calc(62px + env(safe-area-inset-bottom));left:50%;transform:translateX(-50%);background:var(--acc);color:#0d1014;font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:15px;padding:9px 20px;border-radius:99px;z-index:400;white-space:nowrap;pointer-events:none;animation:fio 2.5s forwards}
    @keyframes fio{0%{opacity:0;transform:translateX(-50%) translateY(8px)}12%{opacity:1;transform:translateX(-50%)}75%{opacity:1}100%{opacity:0}}
    .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100dvh;gap:14px;color:var(--t2);font-size:14px}
    .spinner{width:36px;height:36px;border:3px solid var(--brd);border-top-color:var(--acc);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    ::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--brd);border-radius:99px}
  </style>
</head>
<body>
<div id="app"><div class="loading"><div class="spinner"></div><span>Coolvarko NaplÃ³ betÃ¶ltÃ©seâ€¦</span></div></div>
<script>
const AKTIVITASOK = {
  "AlapozÃ¡s, FÃ¶ldmunka, VasalÃ¡s":["Ã‰pÃ¼let kitÅ±zÃ©s","FÃ¶ld kitermelÃ©s, deponÃ¡lÃ¡s","KÃ©zi Ã¡rokÃ¡sÃ¡s (talajosztÃ¡ly 1-2)","SÃ¡valap alapÃ¡rok gÃ©pi kiemelÃ©se","Pontalap gÃ¶dÃ¶r gÃ©pi kiemelÃ©se","Pince gÃ¶dÃ¶r gÃ©pi kiemelÃ©s","SÃ¡valap alapÃ¡sÃ¡s","SÃ¡valap Ã¡rok kÃ©zi tisztÃ­tÃ¡sa","SÃ³der/kavics feltÃ¶ltÃ©s + tÃ¶mÃ¶rÃ­tÃ©s","FÃ¶ldfeltÃ¶ltÃ©s, tÃ¶mÃ¶rÃ­tÃ©s","FÃ¶ld elszÃ¡llÃ­tÃ¡sa, sÃ³der beszÃ¡llÃ­tÃ¡sa","SÃ¡valap vasalÃ¡s","SzerelÅ‘beton vasalÃ¡s","Hegesztett hÃ¡lÃ³ fektetÃ©se 100Ã—100 mm","Hegesztett hÃ¡lÃ³ fektetÃ©se 150Ã—150 mm","KÃ©zi fÃºrÃ¡s, furat Ã˜25 cm-ig"],
  "BetonozÃ¡si MunkÃ¡k":["AlapbetonozÃ¡s gÃ©pi","SÃ¡valap betonozÃ¡s (mixerbetonnal)","SÃ¡valap betonozÃ¡s (kÃ©zileg)","KÃ©zi betonozÃ¡s Ã¡ltalÃ¡nos","AljzatbetonozÃ¡s 6cm-ig","KÃ©zi bedolgozÃ¡sÃº aljzatbeton max 7 cm","Vastag alaplÃ©teg betonozÃ¡sa 100 mm-ig","Vastag alaplÃ©teg betonozÃ¡sa 150 mm-ig","Vastag alaplÃ©teg betonozÃ¡sa 200 mm-ig","SzerelÅ‘betonozÃ¡s","TÃ©rbetonozÃ¡s / jÃ¡rda, kocsibeÃ¡llÃ³","BetonozÃ¡s kÃ©zi keverÃ©ssel","Mennyezeti fÃ¶dÃ©m bezsaluzÃ¡sa","Doka, Peri rendszer szÃ©tszerelÃ©se","Egyenes lÃ©pcsÅ‘ zsaluzatÃ¡nak beÃ©pÃ­tÃ©se","LÃ©pcsÅ‘zsaluzat szÃ©tszerelÃ©se","GÃ©pi esztrich â€“ cementes","GÃ©pi esztrich â€“ anhidrit Ã¶nterÃ¼lÅ‘","KerÃ¡mia mennyezet beÃ©pÃ­tÃ©se"],
  "KoszorÃº, ZsalukÅ‘ Ã©s ZsaluzÃ¡s":["VaskoszorÃº szerelÃ©s","Vasbeton koszorÃº","ZsalukÃ¶vezÃ©s 15-Ã¶s","ZsalukÃ¶vezÃ©s 20-as","ZsalukÃ¶vezÃ©s 30-as","ZsalukÃ¶vezÃ©s 40-es","LÃ¡bazat kÃ©szÃ­tÃ©s zsalukÅ‘bÅ‘l (1 sor)","ZsaluzÃ¡s tÃ¡blÃ¡sÃ­tott","ZsaluzÃ¡s egyoldali","ZsaluzÃ¡s kÃ©toldali falzsalu","ZsaluzÃ¡s pillÃ©r"],
  "FalazÃ¡s":["FÅ‘falazÃ¡s 25-as","FÅ‘falazÃ¡s 30-as","FÅ‘falazÃ¡s 38-as","FÅ‘falazÃ¡s 44-es","FalazÃ¡s durva szerkezet 30cm (Porotherm/Ytong)","KÃ¶rÃ¼lhatÃ¡rolÃ³ falak tÃ©glafalazÃ¡sa 30cm-ig","VÃ¡laszfalazÃ¡s 10-es","VÃ¡laszfal falazÃ¡sa max 12,5 cm","ÃœvegtÃ©gla rakÃ¡s","TermÃ©skÅ‘ rakÃ¡s","BurkolÃ³ / kistÃ©gla rakÃ¡s","PillÃ©rek kÃ©szÃ­tÃ©se kistÃ©glÃ¡bÃ³l","Vasbeton pillÃ©r kÃ©szÃ­tÃ©s","ÃthidalÃ³k beÃ©pÃ­tÃ©se","Monolit Ã¡thidalÃ³ (zsalu+vasalÃ¡s+beton)","Monolit lÃ©pcsÅ‘ (110cm szÃ©lesig)","Samott kÃ©mÃ©ny kerÃ¡mia bÃ©lÃ©ssel","Schiedel kÃ©mÃ©ny kerÃ¡mia bÃ©lÃ©ssel","KerÃ­tÃ©sÃ©pÃ­tÃ©s hagyomÃ¡nyos"],
  "FÃ¶dÃ©m Ã©s TetÅ‘szerkezet":["E-gerendÃ¡s fÃ¶dÃ©m","Porotherm fÃ¶dÃ©m","Monolit fÃ¶dÃ©m","TetÅ‘tÃ©r szigetelÃ©s (szerkezet+fÃ³lia+karton)"],
  "VakolÃ¡s":["KÃ©zi vakolÃ¡s durvÃ¡zva (mÃ©sz-cement)","KÃ©zi vakolÃ¡s simÃ­tva","GÃ©pi vakolÃ¡s mÃ©sz-cement","Finom mÃ©sz-cement vakolat (Feinputz)","Gipsz/glett vakolat","KÃ¼lsÅ‘ vakolatok","SimÃ­tÃ³ vakolat beltÃ©r/kÃ¼ltÃ©r","Mennyezetivakolat simÃ­tÃ¡sa","Falvakolat simÃ­tÃ¡sa","GipszelÃ©s â€“ bandÃ¡zsolÃ¡s","Ã‰lvÃ©dÅ‘zÃ©s","AblakkÃ¡va"],
  "HÅ‘szigetelÃ©s Ã©s Homlokzat":["Homlokzati hÅ‘szigetelÃ©s EPS polisztirol","Homlokzati hÅ‘szigetelÃ©s Ã¡svÃ¡nygyapot","ETICS komplett rendszer 20cm-ig","Komplett dryvitolÃ¡s (10cm)","KÃ¼lsÅ‘ falak vakolÃ¡sa vÃ©konyrÃ©tegÅ± kapart 2mm","KÃ¼lsÅ‘ falak bevonÃ¡sa Ã¼vegtextil rÃ¡ccsal","HomlokzatszÃ­nezÃ©s alapozÃ¡ssal","KÅ‘porozÃ¡s","ViakolorozÃ¡s","DryvitolÃ¡s + szÃ­nezÃ©s 10 cm","TetÅ‘tÃ©r hÅ‘szigetelÃ©s","ÃllvÃ¡nyozÃ¡s / emelvÃ©ny","SzellÅ‘zÅ‘rÃ¡cs beÃ©pÃ­tÃ©se"],
  "Gipszkarton SzerelÃ©s":["GK vÃ¡laszfal 2Ã—2 rÃ©teg + szigetelÃ©s","GK vÃ¡laszfal 2Ã—1 rÃ©teg + szigetelÃ©s","GK elÅ‘tÃ©tfal 2 rÃ©teg + szigetelÃ©s","GK elÅ‘tÃ©tfal 1 rÃ©teg + szigetelÃ©s","GK elÅ‘tÃ©tfal ragasztva","Ãlmennyezet 2 rÃ©teg + szigetelÃ©s + fÃ³lia","Ãlmennyezet 1 rÃ©teg + szigetelÃ©s + fÃ³lia","Ãlmennyezet 1 rÃ©teg","Ãlmennyezet minerÃ¡l/kazettÃ¡s","GK ferde sÃ­kok Ã©s mennyezetek tetÅ‘tÃ©rben","PÃ¡razÃ¡rÃ³ fÃ³lia beÃ©pÃ­tÃ©se GK Ã¡lmennyezetbe","GK vÃ¡laszfal Knauf Habito","GK vÃ¡laszfal Knauf Diamant","DobozolÃ¡s + rejtett vilÃ¡gÃ­tÃ¡s","Ãves falak GK"],
  "FestÃ©si MunkÃ¡k":["RÃ©gi festÃ©k lekaparÃ¡sa","RÃ©gi olajfestÃ©k lekaparÃ¡sa","Falfix mÃ©lyalapozÃ³ felhordÃ¡sa","FestÃ©s fal alapozÃ¡sa (2x fehÃ©r festÃ©k)","FalfestÃ©s szÃ­nes bevonat","SarokgyÃ¶ngyÃ¶k felszerelÃ©se","Falak tapÃ©tÃ¡zÃ¡sa","Velencei stukkÃ³ polÃ­rozott simÃ­tÃ³val","RepedÃ©sek kijavÃ­tÃ¡sa falakon Ã©s mennyezeten","CsatlakozÃ¡sok akrilÃ¡ciÃ³ja","FÅ±tÃ©scsÃ¶vek festÃ©se","RadiÃ¡torok festÃ©se"],
  "BurkolÃ¡si MunkÃ¡k":["Aljzat kiegyenlÃ­tÃ©s","CsempefektetÃ©s max 60cm-es lapok","CsempefektetÃ©s Gres 60cm felett","CsempefektetÃ©s nagymÃ©retÅ± 60Ã—120 cm","CsempefektetÃ©s nagymÃ©retÅ± 120Ã—260 cm","OldalfalburkolÃ¡s csempe","PillÃ©rburkolÃ¡s","LÃ©pcsÅ‘burkolÃ¡s","DiagonÃ¡l burkolÃ¡s","MÃ¡rvÃ¡nyburkolÃ¡s","Mozaik csempÃ©zÃ©s","TermÃ©szetes / mÅ±kÅ‘ / klinkertÃ©gla burkolat","LÃ¡bazatburkolÃ¡s","SzilikonozÃ¡s / sarkok szilikonozÃ¡sa","Csempe Ã©s jÃ¡rÃ³lap fugÃ¡zÃ¡sa","VÃ­zszigetelÅ‘ bevonat (fÃ¼rdÅ‘, mosdÃ³, zuhany)","HagyomÃ¡nyos parkettÃ¡zÃ¡s","LaminÃ¡lt parkettÃ¡zÃ¡s + szegÃ©ly","SzÅ‘nyegpadlÃ³ + szegÃ©ly","PVC padlÃ³ + szegÃ©ly","SzegÃ©lyezÃ©sek","KÃ¡d felszerelÃ©se + lefolyÃ³","KÃ¡d kÃ¶rbefalazÃ¡sa","Geberit WC-kÃ©szÃ¼lÃ©k beÃ©pÃ­tÃ©se + kÃ¶rbefalazÃ¡s","MosdÃ³ felszerelÃ©se","Csaptelep felszerelÃ©se"],
  "VÃ­zvezetÃ©k-szerelÃ©s":["VÃ­zvezetÃ©k-szerelÃ©s komplett (lakÃ¡s)","VÃ¡jatok vÃ¡gÃ¡sa vÃ­zvezetÃ©kekhez","Falak lehÃºzÃ¡sa vÃ­zvezetÃ©k-szerelÃ©s utÃ¡n","Geberit szerkezet szerelÃ©se","Zuhanykabin Ã¼vegÃ©nek beszerelÃ©se","EllenÅ‘rzÅ‘ ajtÃ³k beÃ©pÃ­tÃ©se","MosdÃ³kagylÃ³ felszerelÃ©se","KeverÅ‘test felszerelÃ©se (iBox)","KeverÅ‘csapok felszerelÃ©se mosdÃ³/mosogatÃ³","KeverÅ‘csap felszerelÃ©se kÃ¡d","VÃ©gszelepek szerelÃ©se"],
  "TÃ©rkÅ‘ Ã©s SzegÃ©lyek":["TÃ©rkÅ‘ felszedÃ©se","Aljzat elÅ‘kÃ©szÃ­tÃ©se / kiegyenlÃ­tÃ©se","Aljzat lenyomÃ¡sa rezgÅ‘lappal","Durva alaprÃ©teg kÃ©szÃ­tÃ©se","TÃ©rkÅ‘ lerakÃ¡sa 4â€“6 cm vastag","ParkszegÃ©ly beÃ©pÃ­tÃ©se","ÃštszegÃ©ly beÃ©pÃ­tÃ©se","TÃ©rkÅ‘ vÃ¡gÃ¡sa","VÃ­zlevezetÅ‘ folyÃ³ka betonba Ã¡gyazÃ¡sa","SzegÃ©lykÃ¶vek beÃ©pÃ­tÃ©se"],
  "BontÃ¡si MunkÃ¡k":["CsempÃ©k bontÃ¡sa","VÃ¡laszfalak lebontÃ¡sa - tÃ©gla","TÃ¶mÃ¶r tÃ©gla falazat bontÃ¡sa","Vasbeton lemez bontÃ¡sa","RÃ©gi Ãºsztatott padlÃ³ eltÃ¡volÃ­tÃ¡sa","KÃ¡d leszerelÃ©se","BeÃ©pÃ­tett szekrÃ©nyek bontÃ¡sa","RÃ©gi konyhabÃºtor bontÃ¡sa","FÃ©majtÃ³rÃ¡ma lebontÃ¡sa"],
  "VÃ­zszigetelÃ©s / Alapfal VÃ©delem":["KÃ¡trÃ¡ny-/bitumenes lemez felhelyezÃ©se 1 rÃ©teg","DÃ¶rken drÃ©nlemez (Delta-MS) beÃ©pÃ­tÃ©s","Alapfal vÃ­zszigetelÃ©s komplett","Alapfal vÃ­zszigetelÃ©s kÃ©trÃ©tegÅ± vÃ­znyomÃ¡s elleni","Aszfalt szigetelÃ©s (IPA) hegesztÃ©ssel","VÃ­zszigetelÅ‘ bevonat kenhetÅ‘ (fÃ¼rdÅ‘)","VÃ­zszigetelÅ‘ szalagok sarkokra","SzigetelÃ©s GV4 lemezzel"],
};
const EGYSEGEK=["mÂ²","mÂ³","fm","db","kg","t","zsÃ¡k","l","Ã³ra"];
const ANYAGOK=["Beton C16/20","Beton C20/25","Beton C25/30","TÃ©gla (normÃ¡l)","TÃ©gla (porotherm)","BlokktÃ©gla","ZsalukÅ‘ 15","ZsalukÅ‘ 20","ZsalukÅ‘ 30","ZsalukÅ‘ 40","Cement","MÃ©sz","Gipsz","Vakolat gÃ©pi","Vakolat kÃ©zi","BetonacÃ©l Ã˜8","BetonacÃ©l Ã˜10","BetonacÃ©l Ã˜12","BetonacÃ©l Ã˜16","Hegesztett hÃ¡lÃ³","Zsalu deszka","Zsalu tÃ¡bla","ÃllvÃ¡ny elem","VÃ­zszigetelÅ‘ fÃ³lia","Bitumen lemez","Delta-MS drÃ©nlemez","XPS szigetelÃ©s","EPS szigetelÃ©s","ÃsvÃ¡nygyapot","Gipszkarton lap","GK profil","Csempe","JÃ¡rÃ³lap","Parketta","LaminÃ¡lt padlÃ³","FugÃ¡zÃ³","Szilikon","Homok","Kavics","ZÃºzott kÅ‘"];

const S={tab:"rogzit",isAdmin:false,adminSubTab:"projektek",naplo:[],projektek:[],naploFilter:"Mind",wStep:1,wForm:null,wSearch:{},wOpenKat:{},wOpenW:-1,ujPrjModal:false,pinModal:false,szerkesztModal:false,szerkesztId:null,munkasStatFilter:"havi",online:navigator.onLine,toastMsg:null,adminPin:"1234"};

const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,5);
const today=()=>new Date().toISOString().split("T")[0];
const fmt=(d)=>new Date(d).toLocaleDateString("hu-HU");
const freshWorker=()=>({id:uid(),nev:"",munkaorÃ¡k:8,aktivitasok:[],felhasznaltAnyagok:[],igenyeltAnyagok:[]});
const freshForm=()=>({datum:today(),projekt:S.projektek[0]?.nev||"",brigad:[freshWorker()],megjegyzes:""});
function toast(msg){S.toastMsg=msg;render();setTimeout(()=>{S.toastMsg=null;render();},2400);}

const IC={plus:"M12 5v14M5 12h14",edit:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z",list:"M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01",chart:"M18 20V10M12 20V4M6 20v-6",shield:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z",trash:"M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2",search:"M21 21l-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0",chev:"M6 9l6 6 6-6",lock:"M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2zM7 11V7a5 5 0 0 1 10 0v4",dl:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",user:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"};
const icon=(n,sz=20,c="currentColor")=>`<svg width="${sz}" height="${sz}" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${(IC[n]||"").split("M").filter(Boolean).map(s=>`<path d="M${s}"/>`).join("")}</svg>`;
const LOGO=`<svg height="46" viewBox="0 0 460 118" xmlns="http://www.w3.org/2000/svg" style="display:block;flex-shrink:0"><defs><linearGradient id="lgr" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#555"/><stop offset="45%" stop-color="#bbb"/><stop offset="55%" stop-color="#ddd"/><stop offset="100%" stop-color="#555"/></linearGradient><linearGradient id="lgt" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#e0ff55"/><stop offset="28%" stop-color="#9ed400"/><stop offset="65%" stop-color="#5c9400"/><stop offset="100%" stop-color="#2e5000"/></linearGradient></defs><polyline points="28,72 230,12 432,72" fill="none" stroke="url(#lgr)" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/><line x1="28" y1="88" x2="432" y2="88" stroke="url(#lgr)" stroke-width="2.5"/><rect x="22" y="86" width="13" height="5" rx="1.5" fill="url(#lgr)"/><rect x="425" y="86" width="13" height="5" rx="1.5" fill="url(#lgr)"/><text x="230" y="79" text-anchor="middle" font-family="'Arial Black','Impact',sans-serif" font-weight="900" font-size="51" fill="url(#lgt)" stroke="#1a3d00" stroke-width="1" letter-spacing="2">COOLVARKO</text><text x="230" y="110" text-anchor="middle" font-family="Arial,sans-serif" font-weight="300" font-size="11" fill="#666" letter-spacing="8">â€” KFT â€”</text></svg>`;

// â”€â”€ AktivitÃ¡s picker munkÃ¡sonkÃ©nt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function aktPicker(wi){
  const w=S.wForm.brigad[wi], sel=w.aktivitasok||[], srch=(S.wSearch[wi]||"").toLowerCase(), ok=S.wOpenKat[wi]||{};
  const filt=srch?Object.fromEntries(Object.entries(AKTIVITASOK).map(([k,v])=>[k,v.filter(a=>a.toLowerCase().includes(srch))]).filter(([,v])=>v.length)):AKTIVITASOK;
  let h=`<div class="srch-w"><span class="srch-ic">${icon("search",15)}</span>
    <input class="inp" placeholder="KeresÃ©s a tevÃ©kenysÃ©gek kÃ¶zÃ¶ttâ€¦" value="${(S.wSearch[wi]||"").replace(/"/g,"&quot;")}"
      oninput="S.wSearch[${wi}]=this.value;render()" style="padding-left:33px"/></div>`;
  if(sel.length) h+=`<div style="padding:6px 10px;background:rgba(126,200,0,.1);border:1px solid rgba(126,200,0,.3);border-radius:8px;font-size:12px;margin-bottom:8px"><span style="color:var(--acc);font-weight:700">${sel.length} kivÃ¡lasztva:</span> <span style="color:var(--t2);font-size:11px">${sel.slice(0,3).join(", ")}${sel.length>3?"â€¦":""}</span></div>`;
  for(const [kat,items] of Object.entries(filt)){
    const isOpen=srch||ok[kat], cnt=items.filter(a=>sel.includes(a)).length;
    h+=`<div class="kath" onclick="S.wOpenKat[${wi}]=S.wOpenKat[${wi}]||{};S.wOpenKat[${wi}]['${kat.replace(/'/g,"\\'")}']=!S.wOpenKat[${wi}]['${kat.replace(/'/g,"\\'")}'];render()">
      <span>${kat}${cnt?`<span class="badge" style="margin-left:6px">${cnt}</span>`:""}</span>
      <span class="karr ${isOpen?"op":""}">${icon("chev",14)}</span></div>`;
    if(isOpen) h+=`<div class="pg">${items.map(a=>`<div class="pill ${sel.includes(a)?"on":""}" onclick="wToggleAkt(${wi},'${a.replace(/'/g,"\\'")}')"><span>${a}</span></div>`).join("")}</div>`;
  }
  return h;
}

// â”€â”€ Anyag sorok â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function anyagSorok(wi, t){
  const key=t==="f"?"felhasznaltAnyagok":"igenyeltAnyagok", arr=S.wForm.brigad[wi][key]||[];
  const col=t==="f"?"var(--grn)":"var(--acc)", lbl=t==="f"?"FelhasznÃ¡lt":"IgÃ©nyelt";
  return arr.map((a,i)=>`<div style="background:var(--bg);border:1px solid var(--brd);border-radius:8px;padding:10px;margin-bottom:7px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px">
      <span style="font-size:11px;color:${col};font-weight:700">${lbl} #${i+1}</span>
      <button class="btn btn-d" onclick="wRemA(${wi},'${t}',${i})">âœ•</button>
    </div>
    <div class="fld" style="margin-bottom:7px">
      <input list="dal${wi}${t}${i}" class="inp" placeholder="Anyag neveâ€¦" value="${a.nev}" oninput="wUpdA(${wi},'${t}',${i},'nev',this.value)"/>
      <datalist id="dal${wi}${t}${i}">${ANYAGOK.map(x=>`<option value="${x}"/>`).join("")}</datalist>
    </div>
    <div class="r2">
      <input type="number" class="inp" placeholder="MennyisÃ©g" min="0" step="0.1" value="${a.mennyiseg}" oninput="wUpdA(${wi},'${t}',${i},'mennyiseg',this.value)"/>
      <select class="sel" onchange="wUpdA(${wi},'${t}',${i},'egyseg',this.value)">${EGYSEGEK.map(e=>`<option${a.egyseg===e?" selected":""}>${e}</option>`).join("")}</select>
    </div></div>`).join("");
}

// â”€â”€ WIZARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWizard(){
  if(!S.wForm)S.wForm=freshForm();
  const f=S.wForm, steps=["Alap","BrigÃ¡d","Ã–sszesÃ­tÃ©s"];
  let h=`<div class="stit">Napi bejegyzÃ©s</div><div class="steps">${steps.map((s,i)=>`<div class="step ${S.wStep===i+1?"on":S.wStep>i+1?"dn":""}">${s}</div>`).join("")}</div>`;

  if(S.wStep===1){
    const opts=S.projektek.map(p=>`<option value="${p.nev}"${f.projekt===p.nev?" selected":""}>${p.nev}</option>`).join("");
    h+=`<div class="card"><div class="ctit"><span style="color:var(--acc)">1.</span> Alapadatok</div>
      <div class="fld"><label class="lbl">DÃ¡tum</label><input type="date" class="inp" id="wD" value="${f.datum}"/></div>
      <div class="fld"><label class="lbl">Projekt</label><div class="r2" style="gap:6px">
        <select class="sel" id="wP">${opts}</select>
        <button class="btn btn-s btn-ic" onclick="S.ujPrjModal=true;render()">${icon("plus",18)}</button>
      </div></div>
      <div class="fld"><label class="lbl">MegjegyzÃ©s</label><textarea class="ta" id="wM" placeholder="Napi megjegyzÃ©sek, idÅ‘jÃ¡rÃ¡sâ€¦">${f.megjegyzes}</textarea></div>
      <button class="btn btn-p" onclick="wNext()">TovÃ¡bb: BrigÃ¡d â†’</button>
    </div>`;
  }

  else if(S.wStep===2){
    const totalH=f.brigad.reduce((s,w)=>s+Number(w.munkaorÃ¡k||0),0);
    const totalA=f.brigad.reduce((s,w)=>s+(w.aktivitasok||[]).length,0);
    h+=`<div class="card"><div class="ctit"><span style="color:var(--acc)">2.</span> BrigÃ¡d tagok</div>
      <div style="padding:10px 13px;background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.3);border-radius:8px;margin-bottom:13px;font-size:14px">
        ğŸ‘· <strong style="color:var(--a2)">${f.brigad.length} fÅ‘</strong> Â· <strong style="color:var(--acc)">${totalH} Ã³ra</strong> Â· <strong style="color:var(--grn)">${totalA} tevÃ©kenysÃ©g</strong>
      </div>`;

    f.brigad.forEach((w,wi)=>{
      const isOpen=S.wOpenW===wi, ac=(w.aktivitasok||[]).length, fc=(w.felhasznaltAnyagok||[]).length+(w.igenyeltAnyagok||[]).length;
      h+=`<div class="wcard"><div class="wcard-h" onclick="S.wOpenW=S.wOpenW===${wi}?-1:${wi};render()">
        <div><div style="font-weight:700;font-size:14px;display:flex;align-items:center;gap:7px">
          ${icon("user",15,"var(--a2)")} ${w.nev||`#${wi+1} MunkÃ¡s`} ${ac?`<span class="badge">${ac}</span>`:""}
        </div>
        <div style="font-size:12px;color:var(--t2);margin-top:2px">${w.munkaorÃ¡k} Ã³ra${fc?` Â· ${fc} anyag`:""}</div></div>
        <div style="display:flex;align-items:center;gap:6px">
          ${f.brigad.length>1?`<button class="btn btn-d" style="padding:4px 8px" onclick="event.stopPropagation();wRemW(${wi})">${icon("trash",13)}</button>`:""}
          <span class="karr ${isOpen?"op":""}">${icon("chev",16)}</span>
        </div></div>`;
      if(isOpen) h+=`<div class="wcard-body">
        <div class="r2" style="margin-bottom:11px">
          <div><label class="lbl">NÃ©v</label><input class="inp" placeholder="MunkÃ¡s neve" value="${w.nev}" oninput="S.wForm.brigad[${wi}].nev=this.value"/></div>
          <div><label class="lbl">MunkaÃ³ra</label><input type="number" class="inp" min="1" max="16" step="0.5" value="${w.munkaorÃ¡k}" oninput="S.wForm.brigad[${wi}].munkaorÃ¡k=Number(this.value)"/></div>
        </div>
        <hr class="divd" style="margin:10px 0"/>
        <div style="font-size:12px;font-weight:700;color:var(--acc);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">ElvÃ©gzett munkÃ¡k</div>
        ${aktPicker(wi)}
        <hr class="divd" style="margin:12px 0"/>
        <div style="font-size:12px;font-weight:700;color:var(--grn);text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px">âœ… FelhasznÃ¡lt anyagok</div>
        ${anyagSorok(wi,"f")}
        <button class="btn btn-s" style="margin-bottom:13px" onclick="wAddA(${wi},'f')">+ FelhasznÃ¡lt anyag</button>
        <div style="font-size:12px;font-weight:700;color:var(--acc);text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px">âš¡ IgÃ©nyelt anyagok (holnapra)</div>
        ${anyagSorok(wi,"i")}
        <button class="btn btn-s" onclick="wAddA(${wi},'i')">+ AnyagigÃ©ny</button>
      </div>`;
      h+=`</div>`;
    });

    h+=`<button class="btn btn-s" style="margin-top:6px;margin-bottom:13px" onclick="wAddW()">${icon("plus",16)} MunkÃ¡s hozzÃ¡adÃ¡sa</button>
    <hr class="divd"/><div class="r2">
      <button class="btn btn-s" onclick="wPrev()">â† Vissza</button>
      <button class="btn btn-p" onclick="wNext()">Ã–sszesÃ­tÃ©s â†’</button>
    </div></div>`;
  }

  else if(S.wStep===3){
    const totalH=f.brigad.reduce((s,w)=>s+Number(w.munkaorÃ¡k||0),0);
    h+=`<div class="card"><div class="ctit"><span style="color:var(--acc)">3.</span> Ã–sszesÃ­tÃ©s</div>
      <div style="padding:12px;background:var(--s2);border-radius:8px;margin-bottom:13px">
        <div style="font-weight:700;font-size:15px;color:var(--acc)">${f.projekt}</div>
        <div style="font-size:13px;color:var(--t2)">${fmt(f.datum)} Â· ${f.brigad.length} fÅ‘ Â· ${totalH} Ã³ra</div>
      </div>
      ${f.brigad.map(w=>`<div style="padding:10px;background:var(--s2);border-radius:8px;margin-bottom:7px;border:1px solid var(--brd)">
        <div style="font-weight:700;font-size:14px;margin-bottom:5px">${w.nev||"(nÃ©vtelen)"} â€” ${w.munkaorÃ¡k} Ã³ra</div>
        ${(w.aktivitasok||[]).length?`<div style="margin-bottom:4px">${w.aktivitasok.map(a=>`<span class="lt">${a}</span>`).join("")}</div>`:""}
        ${(w.felhasznaltAnyagok||[]).length?`<div>${w.felhasznaltAnyagok.map(a=>`<span class="lt m">${a.nev} ${a.mennyiseg} ${a.egyseg}</span>`).join("")}</div>`:""}
        ${(w.igenyeltAnyagok||[]).length?`<div>${w.igenyeltAnyagok.map(a=>`<span class="lt r">âš¡${a.nev} ${a.mennyiseg} ${a.egyseg}</span>`).join("")}</div>`:""}
      </div>`).join("")}
      ${f.megjegyzes?`<div style="padding:10px;background:var(--s2);border-radius:8px;font-size:13px;color:var(--t2);border:1px solid var(--brd);margin-bottom:13px">ğŸ“ ${f.megjegyzes}</div>`:""}
      <hr class="divd"/>
      <button class="btn btn-p" onclick="wMentes()" style="margin-bottom:8px">âœ“ BejegyzÃ©s mentÃ©se</button>
      <button class="btn btn-s" onclick="wPrev()">â† Vissza</button>
    </div>`;
  }
  return h;
}

// â”€â”€ NaplÃ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNaplo(){
  const all=S.naplo, projektek=["Mind",...new Set(all.map(n=>n.projekt))];
  const filtered=S.naploFilter==="Mind"?all:all.filter(n=>n.projekt===S.naploFilter);
  let h=`<div class="stit">NaplÃ³</div><div class="fb">${projektek.map(p=>`<button class="fbb ${S.naploFilter===p?"on":""}" onclick="S.naploFilter='${p.replace(/'/g,"\\'")}';render()">${p}</button>`).join("")}</div>`;
  if(!filtered.length) return h+`<div class="empty"><p>MÃ©g nincs bejegyzÃ©s</p></div>`;
  filtered.forEach(n=>{
    const brigad=n.brigad||[], totalH=brigad.reduce((s,w)=>s+Number(w.munkaorÃ¡k||0),0);
    const allF=brigad.flatMap(w=>w.felhasznaltAnyagok||[]), allI=brigad.flatMap(w=>w.igenyeltAnyagok||[]);
    h+=`<div class="le"><div class="leh"><div>
      <div class="lp">${n.projekt}</div><div class="ld">${fmt(n.datum)}</div>
    </div><div style="display:flex;gap:5px"><button class="btn btn-s" style="padding:5px 9px;width:auto;font-size:11px;border-radius:6px" onclick="naploSzerkeszt('${n.id}')">${icon('edit',13)} Szerk.</button><button class="btn btn-d" onclick="naploTorol('${n.id}')">${icon("trash",13)}</button></div></div>
    <span class="lt w">ğŸ‘· ${brigad.length} fÅ‘ â€” ${totalH} Ã³ra</span>
    ${brigad.map(w=>`<div style="font-size:12px;color:var(--t2);margin-top:4px">
      <strong style="color:var(--txt)">${w.nev||"(nÃ©vtelen)"}</strong> ${w.munkaorÃ¡k}h
      ${(w.aktivitasok||[]).map(a=>`<span class="lt" style="margin:1px">${a}</span>`).join("")}
    </div>`).join("")}
    ${allF.length?`<div style="margin-top:5px">${allF.map(a=>`<span class="lt m">${a.nev} ${a.mennyiseg} ${a.egyseg}</span>`).join("")}</div>`:""}
    ${allI.length?`<div>${allI.map(a=>`<span class="lt r">âš¡${a.nev} ${a.mennyiseg} ${a.egyseg}</span>`).join("")}</div>`:""}
    ${n.megjegyzes?`<div style="margin-top:7px;font-size:13px;color:var(--t2);border-top:1px solid var(--brd);padding-top:7px">${n.megjegyzes}</div>`:""}
    </div>`;
  });
  return h;
}

// â”€â”€ Statisztika â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HÃ©t sorszÃ¡ma
function getWeekNum(d){const dt=new Date(d);const jan1=new Date(dt.getFullYear(),0,1);return Math.ceil((((dt-jan1)/86400000)+jan1.getDay()+1)/7);}
function getMonthName(d){return new Date(d).toLocaleDateString("hu-HU",{year:"numeric",month:"long"});}
function getWeekLabel(d){const dt=new Date(d);const mon=new Date(dt);mon.setDate(dt.getDate()-((dt.getDay()+6)%7));const sun=new Date(mon);sun.setDate(mon.getDate()+6);return mon.toLocaleDateString("hu-HU",{month:"short",day:"numeric"})+" â€“ "+sun.toLocaleDateString("hu-HU",{month:"short",day:"numeric"});}

function renderStat(){
  const naplo=S.naplo;
  const osszesMO=naplo.reduce((s,n)=>s+(n.brigad||[]).reduce((ss,w)=>ss+Number(w.munkaorÃ¡k||0),0),0);
  
  // Egyedi munkÃ¡sok (trim nÃ©vvel)
  const munkasMap={};
  naplo.forEach(n=>{
    (n.brigad||[]).forEach(w=>{
      const nev=(w.nev||"").trim();
      if(!nev)return;
      if(!munkasMap[nev])munkasMap[nev]={osszes:0,napok:0,hetek:{},honapok:{},aktivitasok:{}};
      const ora=Number(w.munkaorÃ¡k||0);
      munkasMap[nev].osszes+=ora;
      munkasMap[nev].napok++;
      // Heti bontÃ¡s
      const hetLabel=getWeekLabel(n.datum);
      munkasMap[nev].hetek[hetLabel]=(munkasMap[nev].hetek[hetLabel]||0)+ora;
      // Havi bontÃ¡s
      const honLabel=getMonthName(n.datum);
      munkasMap[nev].honapok[honLabel]=(munkasMap[nev].honapok[honLabel]||0)+ora;
      (w.aktivitasok||[]).forEach(a=>{munkasMap[nev].aktivitasok[a]=(munkasMap[nev].aktivitasok[a]||0)+1;});
    });
  });

  const prjMap={};naplo.forEach(n=>{if(!prjMap[n.projekt])prjMap[n.projekt]={napok:0,orak:0};prjMap[n.projekt].napok++;prjMap[n.projekt].orak+=(n.brigad||[]).reduce((s,w)=>s+Number(w.munkaorÃ¡k||0),0);});
  const aktMap={};naplo.forEach(n=>(n.brigad||[]).forEach(w=>(w.aktivitasok||[]).forEach(a=>{aktMap[a]=(aktMap[a]||0)+1;})));
  const topAkt=Object.entries(aktMap).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const anyMap={};naplo.forEach(n=>(n.brigad||[]).forEach(w=>(w.felhasznaltAnyagok||[]).forEach(a=>{if(!a.nev)return;if(!anyMap[a.nev])anyMap[a.nev]={};const e=a.egyseg||"db";anyMap[a.nev][e]=(anyMap[a.nev][e]||0)+Number(a.mennyiseg||0);})));
  const igMap={};naplo.forEach(n=>(n.brigad||[]).forEach(w=>(w.igenyeltAnyagok||[]).forEach(a=>{if(!a.nev)return;if(!igMap[a.nev])igMap[a.nev]={};const e=a.egyseg||"db";igMap[a.nev][e]=(igMap[a.nev][e]||0)+Number(a.mennyiseg||0);})));
  const egyediMunkasok=Object.keys(munkasMap).length;
  let h=`<div class="stit">StatisztikÃ¡k</div>
  <div class="stats">
    <div class="stat"><div class="sv">${naplo.length}</div><div class="sl">BejegyzÃ©s</div></div>
    <div class="stat"><div class="sv">${egyediMunkasok}</div><div class="sl">MunkÃ¡s</div></div>
    <div class="stat"><div class="sv">${osszesMO}</div><div class="sl">MunkaÃ³ra</div></div>
    <div class="stat"><div class="sv">${Object.keys(prjMap).length}</div><div class="sl">Projekt</div></div>
  </div>`;
  if(topAkt.length) h+=`<div class="card" style="margin-bottom:11px"><div class="ctit">ğŸ”§ Leggyakoribb munkÃ¡k</div>${topAkt.map(([a,cnt])=>`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><span style="font-size:13px;flex:1;margin-right:8px">${a}</span><div style="display:flex;align-items:center;gap:8px"><div style="width:55px;height:5px;background:var(--s2);border-radius:99px;overflow:hidden"><div style="width:${Math.min(100,(cnt/naplo.length)*100)}%;height:100%;background:var(--acc);border-radius:99px"></div></div><span class="badge">${cnt}</span></div></div>`).join("")}</div>`;
  if(Object.keys(anyMap).length) h+=`<div class="card" style="margin-bottom:11px"><div class="ctit">ğŸ“¦ FelhasznÃ¡lt anyagok</div>${Object.entries(anyMap).map(([nev,eg])=>`<div class="rb"><div class="rbn">${nev}</div><div>${Object.entries(eg).map(([e,a])=>`<div class="rba">${Number(a).toFixed(1)} ${e}</div>`).join("")}</div></div>`).join("")}</div>`;
  if(Object.keys(igMap).length) h+=`<div class="card" style="margin-bottom:11px"><div class="ctit">âš¡ AnyagigÃ©nyek Ã¶sszesÃ­tve</div>${Object.entries(igMap).map(([nev,eg])=>`<div class="rb"><div class="rbn">${nev}</div><div>${Object.entries(eg).map(([e,a])=>`<div class="rba">${Number(a).toFixed(1)} ${e}</div>`).join("")}</div></div>`).join("")}</div>`;
  // MunkÃ¡s teljesÃ­tmÃ©ny kÃ¡rtya
  if(Object.keys(munkasMap).length){
    const statFilter=S.munkasStatFilter||"havi";
    h+=`<div class="card" style="margin-bottom:11px">
      <div class="ctit">ğŸ‘· MunkÃ¡s teljesÃ­tmÃ©ny</div>
      <div class="fb" style="margin-bottom:11px">
        <button class="fbb ${statFilter==="osszes"?"on":""}" onclick="S.munkasStatFilter='osszes';render()">Ã–sszesÃ­tett</button>
        <button class="fbb ${statFilter==="heti"?"on":""}" onclick="S.munkasStatFilter='heti';render()">Heti</button>
        <button class="fbb ${statFilter==="havi"?"on":""}" onclick="S.munkasStatFilter='havi';render()">Havi</button>
      </div>
      ${Object.entries(munkasMap).sort((a,b)=>b[1].osszes-a[1].osszes).map(([nev,d])=>{
        let reszlet="";
        if(statFilter==="heti"){
          reszlet=Object.entries(d.hetek).map(([h,o])=>`<div style="display:flex;justify-content:space-between;font-size:12px;color:var(--t2);padding:3px 0;border-bottom:1px solid var(--brd)"><span>${h}</span><span style="color:var(--acc);font-weight:700">${o} Ã³ra</span></div>`).join("");
        } else if(statFilter==="havi"){
          reszlet=Object.entries(d.honapok).map(([h,o])=>`<div style="display:flex;justify-content:space-between;font-size:12px;color:var(--t2);padding:3px 0;border-bottom:1px solid var(--brd)"><span>${h}</span><span style="color:var(--acc);font-weight:700">${o} Ã³ra</span></div>`).join("");
        }
        const topAkt=Object.entries(d.aktivitasok).sort((a,b)=>b[1]-a[1]).slice(0,2).map(([a])=>a).join(", ");
        return `<div style="background:var(--s2);border-radius:8px;padding:11px;margin-bottom:8px;border:1px solid var(--brd)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
            <span style="font-weight:700;font-size:15px">${nev}</span>
            <span style="font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:18px;color:var(--acc)">${d.osszes} Ã³ra</span>
          </div>
          <div style="font-size:12px;color:var(--t2);margin-bottom:${reszlet?"7px":"0"}">${d.napok} munkanap${topAkt?" Â· "+topAkt:""}</div>
          ${reszlet?`<div style="margin-top:5px">${reszlet}</div>`:""}
        </div>`;
      }).join("")}
    </div>`;
  }

  if(Object.keys(prjMap).length) h+=`<div class="card"><div class="ctit">ğŸ—ï¸ Projektek</div>${Object.entries(prjMap).map(([p,d])=>`<div style="margin-bottom:9px;padding:8px 10px;background:var(--s2);border-radius:8px"><div style="font-weight:600;font-size:14px;margin-bottom:2px">${p}</div><div style="font-size:13px;color:var(--t2)">${d.napok} munkanap Â· ${d.orak} munkaÃ³ra</div></div>`).join("")}</div>`;
  if(naplo.length>0){
    h+=`<div class="card" style="border-color:rgba(126,200,0,.4);margin-top:11px">
      <div class="ctit">ğŸ¤– AI Ã¶sszefoglalÃ³</div>
      <p style="font-size:12px;color:var(--t2);margin-bottom:10px">MÃ¡sold be Claude-nak ajÃ¡nlatkÃ©szÃ­tÃ©shez vagy elemzÃ©shez:</p>
      <div id="aiBox" style="background:var(--bg);border:1px solid var(--brd);border-radius:8px;padding:12px;font-size:11px;color:var(--t2);white-space:pre-wrap;font-family:monospace;max-height:200px;overflow-y:auto;line-height:1.5;user-select:all">${genAI(naplo)}</div>
      <button class="btn btn-p" style="margin-top:10px" onclick="copyAI()">ğŸ“‹ MÃ¡solÃ¡s Claude-nak</button>
    </div>`;
  }
  return h;
}

// â”€â”€ Admin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAdmin(){
  const sub=S.adminSubTab;
  let h=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
    <div class="stit amb" style="margin-bottom:0">Admin</div>
    <button class="btn btn-d" style="font-size:12px" onclick="S.isAdmin=false;S.tab='rogzit';render()">KilÃ©pÃ©s</button>
  </div>
  <div class="fb" style="margin-bottom:14px">
    <button class="fbb ${sub==="projektek"?"on":""}" onclick="S.adminSubTab='projektek';render()">ğŸ—ï¸ Projektek</button>
    <button class="fbb ${sub==="naplo"?"on":""}" onclick="S.adminSubTab='naplo';render()">ğŸ“‹ NaplÃ³</button>
    <button class="fbb ${sub==="export"?"on":""}" onclick="S.adminSubTab='export';render()">ğŸ“¤ Export</button>
    <button class="fbb ${sub==="beallitas"?"on":""}" onclick="S.adminSubTab='beallitas';render()">âš™ï¸ BeÃ¡llÃ­tÃ¡s</button>
  </div>`;
  if(sub==="projektek"){
    h+=`<button class="btn btn-amb" style="margin-bottom:13px" onclick="S.ujPrjModal=true;render()">${icon("plus",18)} Ãšj projekt lÃ©trehozÃ¡sa</button>`;
    S.projektek.forEach(p=>{
      const napok=S.naplo.filter(n=>n.projekt===p.nev).length;
      const ora=S.naplo.filter(n=>n.projekt===p.nev).reduce((s,n)=>s+(n.brigad||[]).reduce((ss,w)=>ss+Number(w.munkaorÃ¡k||0),0),0);
      h+=`<div class="adm-card"><div style="display:flex;align-items:flex-start;justify-content:space-between">
        <div style="flex:1"><div style="font-weight:700;font-size:15px">${p.nev}</div>
          ${p.helyszin?`<div style="font-size:12px;color:var(--t2)">ğŸ“ ${p.helyszin}</div>`:""}
          ${p.megrendelo?`<div style="font-size:12px;color:var(--t2)">ğŸ‘¤ ${p.megrendelo}</div>`:""}
          <div style="margin-top:5px;font-size:12px;color:var(--t3)">ğŸ“‹ ${napok} nap Â· â± ${ora} Ã³ra</div>
        </div>
        <button class="btn btn-d" style="padding:6px 9px;flex-shrink:0" onclick="prjTorol('${p.id}','${p.nev.replace(/'/g,"\\'")}')">
          ${icon("trash",14)}</button>
      </div></div>`;
    });
    if(!S.projektek.length) h+=`<div class="empty"><p>MÃ©g nincs projekt</p></div>`;
  } else if(sub==="naplo"){
    h+=renderNaplo();
  } else if(sub==="export"){
    h+=`<div class="adm-card"><div class="ctit"><span style="color:var(--amber)">ğŸ“¤</span> Export</div>
      <button class="btn btn-amb" style="margin-bottom:9px" onclick="exportCSV()">${icon("dl",17)} CSV exportÃ¡lÃ¡s (Excel)</button>
      <button class="btn btn-s" onclick="exportJSON()">${icon("dl",17)} JSON exportÃ¡lÃ¡s</button>
    </div>`;
  } else if(sub==="beallitas"){
    h+=`<div class="adm-card"><div class="ctit"><span style="color:var(--amber)">âš™ï¸</span> Admin PIN mÃ³dosÃ­tÃ¡sa</div>
      <p style="font-size:13px;color:var(--t2);margin-bottom:13px">AktuÃ¡lis PIN: <strong style="color:var(--acc)">${S.adminPin}</strong></p>
      <div class="fld"><label class="lbl">Ãšj PIN (min. 4 karakter)</label><input type="password" class="inp" id="ujPin" placeholder="Ãšj PINâ€¦"/></div>
      <div class="fld"><label class="lbl">MegerÅ‘sÃ­tÃ©s</label><input type="password" class="inp" id="ujPin2" placeholder="IsmÃ©teld megâ€¦"/></div>
      <button class="btn btn-amb" onclick="pinMentes()">PIN mentÃ©se</button>
    </div>`;
  }
  return h;
}

// â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderModals(){
  let h="";
  if(S.pinModal){
    h+=`<div class="modal-bg" onclick="if(event.target===this){S.pinModal=false;render()}">
      <div class="modal" style="text-align:center">
        <div style="margin-bottom:11px;color:var(--amber)">${icon("lock",36,"var(--amber)")}</div>
        <div class="modal-tit" style="text-align:center">Admin belÃ©pÃ©s</div>
        <input type="password" class="inp" id="pinInp" maxlength="8" placeholder="â€¢â€¢â€¢â€¢"
          style="text-align:center;font-size:22px;letter-spacing:8px;margin-bottom:11px"
          onkeydown="if(event.key==='Enter')pinCheck()"/>
        <div id="pinErr" style="color:var(--red);font-size:13px;margin-bottom:8px;min-height:18px"></div>
        <div class="r2">
          <button class="btn btn-s" onclick="S.pinModal=false;render()">MÃ©gse</button>
          <button class="btn btn-amb" onclick="pinCheck()">BelÃ©pÃ©s</button>
        </div>
      </div>
    </div>`;
    setTimeout(()=>{const el=document.getElementById("pinInp");if(el)el.focus();},50);
  }
  if(S.szerkesztModal && S.szerkesztId){
    const n = S.naplo.find(x=>x.id===S.szerkesztId);
    if(n){
      const brigad = n.brigad||[];
      h+=`<div class="modal-bg" onclick="if(event.target===this){S.szerkesztModal=false;render()}">
        <div class="modal" style="max-width:420px">
          <div class="modal-tit">âœï¸ BejegyzÃ©s szerkesztÃ©se</div>
          <div class="fld"><label class="lbl">DÃ¡tum</label>
            <input type="date" class="inp" id="szD" value="${n.datum}"/></div>
          <div style="font-size:12px;font-weight:700;color:var(--acc);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">BrigÃ¡d tagok</div>
          ${brigad.map((w,wi)=>`
            <div style="background:var(--s2);border:1px solid var(--brd);border-radius:8px;padding:10px;margin-bottom:8px">
              <div class="r2" style="margin-bottom:8px">
                <div><label class="lbl">NÃ©v</label>
                  <input class="inp" id="szW${wi}nev" value="${w.nev||""}" placeholder="MunkÃ¡s neve"/></div>
                <div><label class="lbl">MunkaÃ³ra</label>
                  <input type="number" class="inp" id="szW${wi}ora" value="${w.munkaorÃ¡k||8}" min="1" max="16" step="0.5"/></div>
              </div>
              <div style="font-size:11px;color:var(--t2);margin-bottom:5px">TevÃ©kenysÃ©gek: <span style="color:var(--acc)">${(w.aktivitasok||[]).join(", ")||"nincs"}</span></div>
              <div style="font-size:11px;color:var(--t2);margin-bottom:5px">FelhasznÃ¡lt anyagok:</div>
              ${(w.felhasznaltAnyagok||[]).map((a,ai)=>`
                <div class="r2" style="margin-bottom:5px;gap:5px">
                  <input class="inp" style="font-size:12px;padding:7px 9px" id="szFA${wi}_${ai}nev" value="${a.nev}" placeholder="Anyag neve"/>
                  <input type="number" class="inp" style="font-size:12px;padding:7px 9px;max-width:70px" id="szFA${wi}_${ai}mn" value="${a.mennyiseg}" placeholder="db"/>
                  <input class="inp" style="font-size:12px;padding:7px 9px;max-width:55px" id="szFA${wi}_${ai}eg" value="${a.egyseg||"mÂ²"}"/>
                </div>`).join("")}
              <button class="btn btn-s" style="font-size:11px;padding:6px;margin-bottom:8px" onclick="szAddAnyag(${wi},'f')">+ FelhasznÃ¡lt anyag</button>
              <div style="font-size:11px;color:var(--t2);margin-bottom:5px">IgÃ©nyelt anyagok:</div>
              ${(w.igenyeltAnyagok||[]).map((a,ai)=>`
                <div class="r2" style="margin-bottom:5px;gap:5px">
                  <input class="inp" style="font-size:12px;padding:7px 9px" id="szIA${wi}_${ai}nev" value="${a.nev}" placeholder="Anyag neve"/>
                  <input type="number" class="inp" style="font-size:12px;padding:7px 9px;max-width:70px" id="szIA${wi}_${ai}mn" value="${a.mennyiseg}" placeholder="db"/>
                  <input class="inp" style="font-size:12px;padding:7px 9px;max-width:55px" id="szIA${wi}_${ai}eg" value="${a.egyseg||"mÂ²"}"/>
                </div>`).join("")}
              <button class="btn btn-s" style="font-size:11px;padding:6px" onclick="szAddAnyag(${wi},'i')">+ IgÃ©nyelt anyag</button>
            </div>`).join("")}
          <div class="fld"><label class="lbl">MegjegyzÃ©s</label>
            <textarea class="ta" id="szMegjegyzes" style="min-height:50px">${n.megjegyzes||""}</textarea></div>
          <div class="r2">
            <button class="btn btn-s" onclick="S.szerkesztModal=false;render()">MÃ©gse</button>
            <button class="btn btn-p" onclick="szMentes()">âœ“ MentÃ©s</button>
          </div>
        </div>
      </div>`;
    }
  }
  if(S.ujPrjModal){
    h+=`<div class="modal-bg" onclick="if(event.target===this){S.ujPrjModal=false;render()}">
      <div class="modal">
        <div class="modal-tit">ğŸ—ï¸ Ãšj projekt</div>
        <div class="fld"><label class="lbl">Projekt neve *</label><input class="inp" id="prjNev" placeholder="pl. VeszprÃ©m â€“ AlapozÃ¡s 2026"/></div>
        <div class="fld"><label class="lbl">HelyszÃ­n / CÃ­m</label><input class="inp" id="prjHely" placeholder="pl. 8200 VeszprÃ©m, FÅ‘ Ãºt 12."/></div>
        <div class="fld"><label class="lbl">MegrendelÅ‘</label><input class="inp" id="prjMegr" placeholder="pl. Iron Building 78 Kft."/></div>
        <div class="fld"><label class="lbl">KezdÃ©si dÃ¡tum</label><input type="date" class="inp" id="prjKezdes" value="${today()}"/></div>
        <div class="r2">
          <button class="btn btn-s" onclick="S.ujPrjModal=false;render()">MÃ©gse</button>
          <button class="btn btn-p" onclick="ujProjektMent()">LÃ©trehozÃ¡s</button>
        </div>
      </div>
    </div>`;
    setTimeout(()=>{const el=document.getElementById("prjNev");if(el)el.focus();},50);
  }
  return h;
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
  const app=document.getElementById("app");if(!app)return;
  const tabs=[{id:"rogzit",lbl:"RÃ¶gzÃ­t",ic:"plus"},{id:"naplo",lbl:"NaplÃ³",ic:"list"},{id:"stat",lbl:"Statisztika",ic:"chart"},{id:"admin",lbl:"Admin",ic:"shield",adm:true}];
  let content="";
  if(S.tab==="rogzit")content=renderWizard();
  else if(S.tab==="naplo")content=renderNaplo();
  else if(S.tab==="stat")content=renderStat();
  else if(S.tab==="admin")content=renderAdmin();
  app.innerHTML=`
    <div class="hdr">${LOGO}
      <div class="hdr-r">
        ${S.isAdmin&&S.tab==="admin"?`<span style="display:flex;align-items:center;gap:4px;background:rgba(245,158,11,.14);border:1px solid rgba(245,158,11,.35);color:var(--amber);padding:4px 8px;border-radius:6px;font-size:11px;font-weight:700">${icon("shield",12,"var(--amber)")} ADMIN</span>`:""}
        <div class="hdr-date">${new Date().toLocaleDateString("hu-HU",{month:"short",day:"numeric"})}</div>
        <div class="dot${S.online?"":" off"}"></div>
      </div>
    </div>
    <div class="cnt">${content}</div>
    <div class="nav">${tabs.map(t=>`<button class="nb ${t.adm?"adm":""} ${S.tab===t.id?"on":""}" onclick="setTab('${t.id}')">${icon(t.ic,20)}<span>${t.lbl}</span></button>`).join("")}</div>
    ${S.toastMsg?`<div class="toast">${S.toastMsg}</div>`:""}
    ${renderModals()}`;
}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.setTab=(t)=>{if(t==="admin"&&!S.isAdmin){S.pinModal=true;render();return;}S.tab=t;render();};
window.wNext=()=>{saveWInputs();S.wStep=Math.min(3,S.wStep+1);render();};
window.wPrev=()=>{saveWInputs();S.wStep=Math.max(1,S.wStep-1);render();};

function saveWInputs(){
  if(!S.wForm)return;
  const d=document.getElementById("wD"),p=document.getElementById("wP"),m=document.getElementById("wM");
  if(d)S.wForm.datum=d.value;if(p)S.wForm.projekt=p.value;if(m)S.wForm.megjegyzes=m.value;
}

window.wAddW=()=>{S.wForm.brigad.push(freshWorker());S.wOpenW=S.wForm.brigad.length-1;render();};
window.wRemW=(i)=>{S.wForm.brigad.splice(i,1);if(S.wOpenW>=S.wForm.brigad.length)S.wOpenW=S.wForm.brigad.length-1;render();};
window.wToggleAkt=(wi,a)=>{const sel=S.wForm.brigad[wi].aktivitasok;const idx=sel.indexOf(a);idx>=0?sel.splice(idx,1):sel.push(a);render();};
window.wAddA=(wi,t)=>{const k=t==="f"?"felhasznaltAnyagok":"igenyeltAnyagok";S.wForm.brigad[wi][k].push({id:uid(),nev:"",mennyiseg:"",egyseg:"mÂ²"});render();};
window.wRemA=(wi,t,i)=>{const k=t==="f"?"felhasznaltAnyagok":"igenyeltAnyagok";S.wForm.brigad[wi][k].splice(i,1);render();};
window.wUpdA=(wi,t,i,k,v)=>{const key=t==="f"?"felhasznaltAnyagok":"igenyeltAnyagok";S.wForm.brigad[wi][key][i][k]=v;};

window.wMentes=async()=>{
  saveWInputs();
  const f=S.wForm;
  if(!f.projekt){toast("âš ï¸ VÃ¡lassz projektet!");return;}
  if(!f.brigad.length){toast("âš ï¸ Adj hozzÃ¡ legalÃ¡bb egy munkÃ¡st!");return;}
  const ures=f.brigad.filter(w=>!w.nev.trim());
  if(ures.length){toast("âš ï¸ Minden munkÃ¡snak adj nevet!");return;}
  try{
    const mentendo={
      datum:f.datum,
      projekt:f.projekt,
      megjegyzes:f.megjegyzes||"",
      brigad:f.brigad.map(w=>({
        nev:(w.nev||'').trim(),
        munkaorÃ¡k:Number(w.munkaorÃ¡k)||8,
        aktivitasok:w.aktivitasok||[],
        felhasznaltAnyagok:w.felhasznaltAnyagok||[],
        igenyeltAnyagok:w.igenyeltAnyagok||[],
      })),
      rogzitve:new Date().toISOString()
    };
    await window.FB.naploMent(mentendo);
    S.wForm=freshForm();S.wStep=1;S.wSearch={};S.wOpenKat={};S.wOpenW=-1;
    toast("âœ“ BejegyzÃ©s mentve Firebase-be!");S.tab="naplo";render();
  }catch(e){toast("âŒ Firebase hiba: "+e.message);console.error(e);}
};

window.naploTorol=async(id)=>{if(!confirm("TÃ¶rlÃ¶d?"))return;try{await window.FB.naploTorol(id);toast("TÃ¶rÃ¶lve.");}catch(e){toast("âŒ Hiba!");}};

window.naploSzerkeszt=(id)=>{
  S.szerkesztId=id;
  S.szerkesztModal=true;
  render();
};

window.szAddAnyag=(wi,t)=>{
  const n=S.naplo.find(x=>x.id===S.szerkesztId);
  if(!n||!n.brigad[wi])return;
  const key=t==='f'?'felhasznaltAnyagok':'igenyeltAnyagok';
  if(!n.brigad[wi][key])n.brigad[wi][key]=[];
  n.brigad[wi][key].push({nev:'',mennyiseg:'',egyseg:'mÂ²'});
  render();
};

window.szMentes=async()=>{
  const n=S.naplo.find(x=>x.id===S.szerkesztId);
  if(!n)return;
  const datum=document.getElementById('szD')?.value||n.datum;
  const megjegyzes=document.getElementById('szMegjegyzes')?.value||'';
  const brigad=(n.brigad||[]).map((w,wi)=>{
    const nev=document.getElementById('szW'+wi+'nev')?.value||w.nev||'';
    const munkaorÃ¡k=Number(document.getElementById('szW'+wi+'ora')?.value)||w.munkaorÃ¡k||8;
    const felhasznaltAnyagok=(w.felhasznaltAnyagok||[]).map((a,ai)=>({
      nev:document.getElementById('szFA'+wi+'_'+ai+'nev')?.value||a.nev||'',
      mennyiseg:document.getElementById('szFA'+wi+'_'+ai+'mn')?.value||a.mennyiseg||'',
      egyseg:document.getElementById('szFA'+wi+'_'+ai+'eg')?.value||a.egyseg||'mÂ²',
    })).filter(a=>a.nev);
    const igenyeltAnyagok=(w.igenyeltAnyagok||[]).map((a,ai)=>({
      nev:document.getElementById('szIA'+wi+'_'+ai+'nev')?.value||a.nev||'',
      mennyiseg:document.getElementById('szIA'+wi+'_'+ai+'mn')?.value||a.mennyiseg||'',
      egyseg:document.getElementById('szIA'+wi+'_'+ai+'eg')?.value||a.egyseg||'mÂ²',
    })).filter(a=>a.nev);
    return {...w,nev,munkaorÃ¡k,felhasznaltAnyagok,igenyeltAnyagok};
  });
  try{
    await window.FB.naploFrissit(S.szerkesztId,{datum,megjegyzes,brigad,projekt:n.projekt});
    S.szerkesztModal=false;
    S.szerkesztId=null;
    toast('âœ“ BejegyzÃ©s frissÃ­tve!');
    render();
  }catch(e){toast('âŒ Hiba: '+e.message);console.error(e);}
};

window.ujProjektMent=async()=>{
  const nev=document.getElementById("prjNev")?.value.trim();
  if(!nev){alert("Add meg a projekt nevÃ©t!");return;}
  try{
    await window.FB.projektMent({nev,helyszin:document.getElementById("prjHely")?.value||"",megrendelo:document.getElementById("prjMegr")?.value||"",kezdes:document.getElementById("prjKezdes")?.value||today()});
    S.ujPrjModal=false;toast("âœ“ Projekt lÃ©trehozva!");
    if(S.wForm)S.wForm.projekt=nev;render();
  }catch(e){toast("âŒ Hiba: "+e.message);}
};

window.prjTorol=async(id,nev)=>{if(!confirm(`TÃ¶rÃ¶ljÃ¼k: "${nev}"?`))return;try{await window.FB.projektTorol(id);toast("Projekt tÃ¶rÃ¶lve.");}catch(e){toast("âŒ Hiba!");}};

window.pinCheck=()=>{
  const inp=document.getElementById("pinInp");if(!inp)return;
  if(inp.value===S.adminPin){S.isAdmin=true;S.pinModal=false;S.tab="admin";render();}
  else{const err=document.getElementById("pinErr");if(err)err.textContent="Helytelen PIN!";inp.value="";setTimeout(()=>{if(err)err.textContent="";},1500);}
};

window.pinMentes=async()=>{
  const p1=document.getElementById("ujPin")?.value,p2=document.getElementById("ujPin2")?.value;
  if(!p1||p1.length<4){toast("âš ï¸ Min. 4 karakter!");return;}
  if(p1!==p2){toast("âš ï¸ A kÃ©t PIN nem egyezik!");return;}
  try{await window.FB.beallitasokMent({pin:p1});S.adminPin=p1;toast("âœ“ PIN mÃ³dosÃ­tva!");}catch(e){toast("âŒ Hiba!");}
};

// â”€â”€ AI Ã¶sszefoglalÃ³ generÃ¡lÃ¡s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genAI(naplo){
  if(!naplo.length) return "MÃ©g nincsenek adatok.";
  const today = new Date().toLocaleDateString("hu-HU");
  const prjMap={}, munkasMap={}, aktMap={};
  naplo.forEach(n=>{
    if(!prjMap[n.projekt]) prjMap[n.projekt]={napok:0,orak:0,munkasok:new Set()};
    prjMap[n.projekt].napok++;
    (n.brigad||[]).forEach(w=>{
      const nev=(w.nev||"").trim();
      const ora=Number(w.munkaorÃ¡k||0);
      prjMap[n.projekt].orak+=ora;
      if(nev) prjMap[n.projekt].munkasok.add(nev);
      if(nev){
        if(!munkasMap[nev]) munkasMap[nev]={orak:0,napok:0,aktivitasok:{}};
        munkasMap[nev].orak+=ora;
        munkasMap[nev].napok++;
        (w.aktivitasok||[]).forEach(a=>{
          munkasMap[nev].aktivitasok[a]=(munkasMap[nev].aktivitasok[a]||0)+1;
          aktMap[a]=(aktMap[a]||0)+1;
        });
      }
    });
  });
  const osszesMO=Object.values(munkasMap).reduce((s,m)=>s+m.orak,0);
  let txt = "=== COOLVARKO KFT. Ã‰PÃTÃ‰SI NAPLÃ“ â€” AI Ã–SSZEFOGLALÃ“ ===\n";
  txt += `GenerÃ¡lva: ${today}\n`;
  txt += `Ã–sszes bejegyzÃ©s: ${naplo.length} nap\n`;
  txt += `Ã–sszes munkaÃ³ra: ${osszesMO} Ã³ra\n\n`;
  txt += "--- PROJEKTEK ---\n";
  Object.entries(prjMap).forEach(([p,d])=>{
    txt += `â€¢ ${p}: ${d.napok} munkanap, ${d.orak} Ã³ra, ${d.munkasok.size} munkÃ¡s\n`;
  });
  txt += "\n--- MUNKÃSOK TELJESÃTMÃ‰NYE ---\n";
  Object.entries(munkasMap).sort((a,b)=>b[1].orak-a[1].orak).forEach(([nev,d])=>{
    const topAkt=Object.entries(d.aktivitasok).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([a])=>a).join(", ");
    txt += `â€¢ ${nev.trim()}: ${d.orak} munkaÃ³ra (${d.napok} nap)\n`;
    if(topAkt) txt += `  FÅ‘ tevÃ©kenysÃ©gek: ${topAkt}\n`;
  });
  const topAkt=Object.entries(aktMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
  if(topAkt.length){
    txt += "\n--- LEGGYAKORIBB MUNKÃK ---\n";
    topAkt.forEach(([a,cnt])=>{ txt += `â€¢ ${a}: ${cnt}x\n`; });
  }
  txt += "\n=== FELHASZNÃLÃS: KÃ©rd Claude-tÃ³l hogy kÃ©szÃ­tsen ajÃ¡nlatot ===";
  return txt;
}
window.copyAI=()=>{
  const el=document.getElementById("aiBox");
  if(!el)return;
  const txt=el.textContent;
  navigator.clipboard.writeText(txt).then(()=>toast("âœ“ MÃ¡solva! Illeszd be Claude-nak.")).catch(()=>{
    el.style.userSelect="all";const r=document.createRange();r.selectNode(el);window.getSelection().removeAllRanges();window.getSelection().addRange(r);toast("JelÃ¶ld ki Ã©s mÃ¡sold (Ctrl+C)");
  });
};

window.exportCSV=()=>{
  const lines=["DÃ¡tum;Projekt;MunkÃ¡s;MunkaÃ³ra;TevÃ©kenysÃ©gek;FelhasznÃ¡lt anyagok;IgÃ©nyelt anyagok;MegjegyzÃ©s"];
  S.naplo.forEach(n=>(n.brigad||[]).forEach(w=>{
    lines.push([n.datum,n.projekt,w.nev||"",w.munkaorÃ¡k,(w.aktivitasok||[]).join(", "),(w.felhasznaltAnyagok||[]).map(a=>`${a.nev} ${a.mennyiseg}${a.egyseg}`).join(", "),(w.igenyeltAnyagok||[]).map(a=>`${a.nev} ${a.mennyiseg}${a.egyseg}`).join(", "),n.megjegyzes||""].join(";"));
  }));
  const a=document.createElement("a");a.href=URL.createObjectURL(new Blob(["\uFEFF"+lines.join("\n")],{type:"text/csv;charset=utf-8"}));a.download=`coolvarko-naplo-${today()}.csv`;a.click();
};
window.exportJSON=()=>{
  const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([JSON.stringify({naplo:S.naplo,projektek:S.projektek},null,2)],{type:"application/json"}));a.download=`coolvarko-naplo-${today()}.json`;a.click();
};

document.addEventListener("firebase-ready",async()=>{
  if(!S.wForm)S.wForm=freshForm();
  try{const b=await window.FB.beallitasokLeker();S.adminPin=b.pin||"1234";}catch(e){}
  window.FB.naploFigyel((data)=>{S.naplo=data;render();});
  window.FB.projektekFigyel((data)=>{S.projektek=data;if(S.wForm&&!S.wForm.projekt&&data.length)S.wForm.projekt=data[0].nev;render();});
  render();
});
window.addEventListener("online",()=>{S.online=true;render();});
window.addEventListener("offline",()=>{S.online=false;render();});
if("serviceWorker"in navigator)navigator.serviceWorker.register("sw.js").catch(()=>{});
</script>
</body>
</html>
